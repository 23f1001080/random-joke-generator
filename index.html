<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Wizarding Joke Book — Enchanted Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Crimson+Pro:wght@400;600;700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent-color: #d4af37; /* Default Gold */
      --paper: #fbf3e6;
      --text: #3e2723;
      --muted: #7e6b5a;
      --radius: 20px;
    }

    /* Update CSS to use --accent-color consistently for full theming */
    
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
      /* ====== Overall Page ====== */
    body {
     
      background-size: cover;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Crimson Pro', serif;
      margin: 0;
      color: #3e2723;
      overflow: hidden;
    }

    /* Subtle floating sparkles */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('https://i.imgur.com/zYzW9hN.png') repeat;
      /* background-size: 360px 360px; */
      animation: sparkle 10s linear infinite;
      opacity: 0.6;
    }

    @keyframes sparkle {
      from { background-position: 0 0; }
      to { background-position: 1000px 1000px; }
    }


    /* Floating orbs layer */
    .orbs {
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;
      overflow:hidden;
    }
    .orb {
      position:absolute;
      border-radius:50%;
      filter: blur(40px);
      opacity:0;
      animation: float 20s infinite ease-in-out;
    }
    .orb:nth-child(1){width:300px;height:300px;background:radial-gradient(circle,rgba(212,175,55,0.3),transparent);top:10%;left:10%;animation-delay:0s;animation-duration:25s}
    .orb:nth-child(2){width:400px;height:400px;background:radial-gradient(circle,rgba(255,215,0,0.2),transparent);bottom:15%;right:15%;animation-delay:3s;animation-duration:30s}
    .orb:nth-child(3){width:250px;height:250px;background:radial-gradient(circle,rgba(212,175,55,0.25),transparent);top:50%;left:50%;animation-delay:6s;animation-duration:20s}
    @keyframes float{
      0%,100%{opacity:0;transform:translate(0,0) scale(1)}
      25%{opacity:0.6;transform:translate(50px,-30px) scale(1.1)}
      50%{opacity:0.4;transform:translate(-30px,40px) scale(0.9)}
      75%{opacity:0.7;transform:translate(40px,-50px) scale(1.05)}
    }

    /* Main container */
    .wrap{
      position:relative;
      width:100%;
      max-width:750px;
      z-index:10;
      padding:2rem;
      animation: entrance 1s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes entrance{
      from{opacity:0;transform:translateY(50px) scale(0.9) rotateX(10deg)}
      to{opacity:1;transform:translateY(0) scale(1) rotateX(0)}
    }

    .card{
      position:relative;
      background: linear-gradient(145deg, 
        rgba(255,252,247,0.98) 0%, 
        rgba(255,248,240,0.96) 50%,
        rgba(252,245,235,0.98) 100%);
      border-radius:var(--radius);
      padding:2rem; /* Reduced from 2.5rem for shorter desktop card */
      overflow:hidden;
      backdrop-filter:blur(20px) saturate(180%);
      /* Enhanced magical glow and shadow based on accent color */
      box-shadow: 
        0 40px 100px rgba(0,0,0,0.6),
        0 0 80px color-mix(in srgb, var(--accent-color) 20%, transparent),
        inset 0 2px 60px rgba(255,240,200,0.4),
        inset 0 -2px 40px color-mix(in srgb, var(--accent-color) 10%, transparent);
      border:3px solid color-mix(in srgb, var(--accent-color) 40%, transparent);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .card:hover{
      transform:translateY(-8px);
      box-shadow: 
        0 50px 120px rgba(0,0,0,0.7),
        0 0 100px color-mix(in srgb, var(--accent-color) 30%, transparent),
        inset 0 2px 60px rgba(255,240,200,0.5);
    }

    /* Animated border shimmer */
    .card::before{
      content:'';
      position:absolute;
      inset:-3px;
      background:linear-gradient(45deg,
        transparent 30%,
        color-mix(in srgb, var(--accent-color) 50%, transparent) 50%,
        transparent 70%);
      background-size:200% 200%;
      border-radius:var(--radius);
      animation:shimmer 3s linear infinite;
      z-index:-1;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    /* Corner decorations */
    .corner{
      position:absolute;
      width:60px;
      height:60px;
      opacity:0.3;
    }
    .corner::before,
    .corner::after{
      content:'';
      position:absolute;
      background:linear-gradient(135deg,var(--accent-color),transparent);
    }
    .corner::before{width:100%;height:3px;top:0;left:0}
    .corner::after{width:3px;height:100%;top:0;left:0}
    .corner.tr{top:1rem;right:1rem;transform:rotate(90deg)}
    .corner.bl{bottom:1rem;left:1rem;transform:rotate(180deg)}
    .corner.br{bottom:1rem;right:1rem;transform:rotate(270deg)}

    /* Header */
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:1.5rem;
      margin-bottom:2rem;
      flex-wrap:wrap;
    }

    h1{
      font-family:'Uncial Antiqua',cursive;
      background:linear-gradient(135deg,#6b4423 0%,var(--accent-color) 30%,#f4d03f 50%,var(--accent-color) 70%,#6b4423 100%);
      background-size:200% 100%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-size:clamp(1.8rem,5vw,3.2rem);
      letter-spacing:2px;
      animation:goldShine 4s ease-in-out infinite;
      filter:drop-shadow(0 2px 10px color-mix(in srgb, var(--accent-color) 30%, transparent));
      margin:0;
    }
    @keyframes goldShine{
      0%,100%{background-position:0% 50%}
      50%{background-position:100% 50%}
    }

    .subtitle{
      color:var(--muted);
      font-size:1rem;
      font-style:italic;
      margin-top:0.5rem;
      opacity:0;
      animation:fadeIn 0.8s ease 0.3s forwards;
    }
    @keyframes fadeIn{
      to{opacity:1}
    }

    /* Controls group */
    .controls-top{
      display:flex;
      gap:0.8rem;
      flex-wrap:wrap;
      align-items:center;
    }

    .color-picker{
      display:flex;
      align-items:center;
      gap:0.6rem;
      background:rgba(255,248,240,0.7);
      padding:8px 14px;
      border-radius:12px;
      border:2px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
      backdrop-filter:blur(8px);
      transition:all 0.3s ease;
    }
    .color-picker:hover{
      background:rgba(255,248,240,0.9);
      border-color:color-mix(in srgb, var(--accent-color) 40%, transparent);
      transform:translateY(-2px);
      box-shadow:0 6px 16px color-mix(in srgb, var(--accent-color) 20%, transparent);
    }
    .color-picker label{
      font-size:0.85rem;
      font-weight:600;
      color:var(--muted);
    }
    input[type="color"]{
      width:40px;
      height:36px;
      border:3px solid color-mix(in srgb, var(--accent-color) 30%, transparent);
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      /* Remove default color input styling */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding: 0;
      background: transparent;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 6px; }
    input[type="color"]:hover{
      transform:scale(1.08) rotate(5deg);
      box-shadow:0 0 20px color-mix(in srgb, var(--accent-color) 50%, transparent);
    }

    /* Joke display area */
    .joke-area{
      min-height:200px; /* Reduced from 220px for shorter desktop card */
      display:flex;
      flex-direction:column;
      gap:1.5rem;
      align-items:center;
      justify-content:center;
      padding:2.5rem 1rem;
      position:relative;
      border-radius:16px;
      background:linear-gradient(135deg,rgba(255,248,235,0.3),rgba(255,240,220,0.2));
      border:2px dashed color-mix(in srgb, var(--accent-color) 15%, transparent);
      transition:all 0.5s ease;
    }
    .joke-area.active{
      background:linear-gradient(135deg,rgba(255,248,235,0.5),rgba(255,240,220,0.4));
      border-color:color-mix(in srgb, var(--accent-color) 30%, transparent);
      box-shadow:inset 0 0 40px color-mix(in srgb, var(--accent-color) 10%, transparent);
    }

    /* Magical Separator Line */
    #separator {
      height: 2px;
      width: 50%;
      max-width: 300px;
      background: var(--accent-color);
      box-shadow: 0 0 10px var(--accent-color), 0 0 20px color-mix(in srgb, var(--accent-color) 50%, transparent);
      border-radius: 1px;
      margin: 0.5rem 0;
      opacity: 0;
      transform: scaleX(0);
      transition: all 0.5s ease;
    }
    .joke-area.active #separator {
      opacity: 0.7;
      transform: scaleX(1);
    }

    #setup{
      font-size:clamp(1.1rem,2.8vw,1.35rem);
      line-height:1.6;
      color:#3b2f2f;
      text-align:center;
      max-width:55ch;
      font-weight:500;
      transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    #setup.loading{
      animation:pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{opacity:0.5;transform:scale(0.98)}
      50%{opacity:1;transform:scale(1.01)}
    }

    #punchline{
      font-family:'Cormorant Garamond',serif;
      font-size:clamp(1.15rem,3vw,1.4rem);
      font-style:italic;
      font-weight:700;
      color:#5d4037;
      text-align:center;
      max-width:60ch;
      padding:1rem 1.5rem;
      background:linear-gradient(135deg,rgba(255,240,200,0.4),rgba(255,230,180,0.3));
      border-radius:14px;
      border:2px solid color-mix(in srgb, var(--accent-color) 20%, transparent);
      box-shadow:0 4px 20px color-mix(in srgb, var(--accent-color) 15%, transparent);
      opacity:0;
      transform:translateY(20px) scale(0.95);
      transition:all 0.9s cubic-bezier(0.34,1.56,0.64,1);
    }
    #punchline.visible{
      opacity:1;
      transform:translateY(0) scale(1);
    }

    /* Buttons */
    .controls{
      display:flex;
      gap:0.8rem;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:1.5rem;
    }

    button{
      font-family:inherit;
      font-weight:700;
      cursor:pointer;
      border:none;
      border-radius:14px;
      transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
      position:relative;
      overflow:hidden;
      white-space:nowrap;
    }
    button:disabled{
      filter:saturate(0.4) brightness(0.8);
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
      background-position:0% 0 !important;
    }

    .btn-main{
      background:linear-gradient(135deg,var(--accent-color) 0%,#f4d03f 50%,var(--accent-color) 100%);
      background-size:200% 100%;
      color:#2a1810;
      padding:16px 32px;
      font-size:1.1rem;
      box-shadow:
        0 10px 25px color-mix(in srgb, var(--accent-color) 40%, transparent),
        0 4px 10px rgba(0,0,0,0.2),
        inset 0 2px 4px rgba(255,255,255,0.4),
        inset 0 -2px 4px rgba(0,0,0,0.1);
      border:2px solid color-mix(in srgb, var(--accent-color) 60%, #000);
    }
    .btn-main::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,transparent,rgba(255,255,255,0.4),transparent);
      transform:translateX(-100%);
      transition:transform 0.6s ease;
      pointer-events:none;
    }
    .btn-main:hover{
      background-position:100% 0;
      transform:translateY(-3px) scale(1.03);
      box-shadow:
        0 15px 35px color-mix(in srgb, var(--accent-color) 50%, transparent),
        0 6px 15px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.5);
    }
    .btn-main:hover::before{
      transform:translateX(100%);
    }
    .btn-main:active{
      transform:translateY(-1px) scale(1);
      box-shadow:
        0 5px 15px color-mix(in srgb, var(--accent-color) 40%, transparent),
        0 2px 5px rgba(0,0,0,0.1),
        inset 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-ghost{
      background:rgba(255,248,240,0.6);
      color:var(--text);
      padding:13px 20px;
      font-size:0.95rem;
      border:2px solid color-mix(in srgb, var(--accent-color) 25%, transparent);
      backdrop-filter:blur(8px);
      font-weight:600;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .btn-ghost:hover{
      background:color-mix(in srgb, var(--accent-color) 15%, transparent);
      border-color:color-mix(in srgb, var(--accent-color) 40%, transparent);
      transform:translateY(-2px);
      box-shadow:0 6px 18px color-mix(in srgb, var(--accent-color) 25%, transparent);
    }
    .btn-ghost:active{
      transform:translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-ghost[data-read-state="reading"] {
      background: color-mix(in srgb, var(--accent-color) 30%, transparent);
      border-color: var(--accent-color);
      box-shadow: 0 0 15px var(--accent-color);
      animation: pulseGlow 1.5s infinite alternate;
    }
    @keyframes pulseGlow {
      from { box-shadow: 0 0 15px var(--accent-color); }
      to { box-shadow: 0 0 5px var(--accent-color), 0 0 25px var(--accent-color); }
    }

    /* Favorites dropdown */
    .favorites{
      position:relative;
    }
    .fav-list{
      position:absolute;
      right:0;
      top:50px;
      min-width:280px;
      max-height:320px;
      overflow-y:auto;
      background:linear-gradient(145deg,rgba(255,252,247,0.98),rgba(255,248,240,0.96));
      backdrop-filter:blur(20px);
      border-radius:16px;
      border:2px solid color-mix(in srgb, var(--accent-color) 30%, transparent);
      box-shadow:0 20px 50px rgba(0,0,0,0.5),0 0 30px color-mix(in srgb, var(--accent-color) 20%, transparent);
      padding:1rem;
      display:none;
      z-index:100;
      animation:dropDown 0.4s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes dropDown{
      from{opacity:0;transform:translateY(-20px) scale(0.9)}
      to{opacity:1;transform:translateY(0) scale(1)}
    }
    .fav-list.show{display:block}
    .fav-item{
      padding:0.8rem;
      margin-bottom:0.5rem;
      background:rgba(255,248,240,0.5);
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--accent-color) 15%, transparent);
      transition:all 0.3s ease;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.8rem;
    }
    .fav-item-text{flex:1;font-size:0.95rem;color:var(--text)}
    .fav-item:hover{
      background:color-mix(in srgb, var(--accent-color) 15%, transparent);
      border-color:color-mix(in srgb, var(--accent-color) 30%, transparent);
      transform:translateX(5px);
      box-shadow:0 4px 12px color-mix(in srgb, var(--accent-color) 20%, transparent);
    }
    .fav-item-controls button{padding:6px 10px;font-size:0.8rem;min-width:30px}
    .fav-empty{
      color:var(--muted);
      text-align:center;
      padding:2rem 1rem;
      font-style:italic;
    }

    /* Status footer */
    .meta{
      margin-top:2rem;
      padding-top:1.5rem;
      border-top:2px solid color-mix(in srgb, var(--accent-color) 15%, transparent);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      flex-wrap:wrap;
      font-size:0.9rem;
      color:var(--muted);
    }

    .status{
      display:flex;
      align-items:center;
      gap:0.5rem;
      font-weight:600;
      color:var(--accent-color);
    }
    .status::before{
      content:'';
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent-color);
      box-shadow:0 0 10px var(--accent-color);
      animation:statusPulse 2s ease-in-out infinite;
    }
    @keyframes statusPulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.5;transform:scale(0.8)}
    }


    /* Scrollbar styling */
    .fav-list::-webkit-scrollbar{width:8px}
    .fav-list::-webkit-scrollbar-track{background:color-mix(in srgb, var(--accent-color) 10%, transparent);border-radius:10px}
    .fav-list::-webkit-scrollbar-thumb{background:color-mix(in srgb, var(--accent-color) 40%, transparent);border-radius:10px}
    .fav-list::-webkit-scrollbar-thumb:hover{background:color-mix(in srgb, var(--accent-color) 60%, transparent)}

    /* Responsive */
    @media (max-width:640px){
      .wrap{padding:0.5rem} /* Reduced padding for mobile */
      .card{padding:1rem} /* More compact padding for mobile */
      header{gap:1rem;justify-content:center}
      h1{font-size:2rem;text-align:center;}
      .subtitle{text-align:center;}
      .controls-top{width:100%;justify-content:center}
      .joke-area{min-height:150px; padding:1.5rem 1rem;} /* Smaller min-height and padding for mobile */
      .fav-list{left:1rem;right:1rem;min-width:auto}
      .controls button{font-size:1rem;padding:12px 24px;}
      .meta{margin-top:1rem; padding-top:1rem;} /* Less margin for mobile */
    }
  </style>
</head>
<body>
  <div class="orbs">
    <div class="orb"></div><div class="orb"></div><div class="orb"></div>
  </div>
  <main class="wrap">
    <div class="card">
      <!-- Corners enhanced to use accent color -->
      <div class="corner" style="--accent-color: var(--accent-color);"></div>
      <div class="corner tr" style="--accent-color: var(--accent-color);"></div>
      <div class="corner bl" style="--accent-color: var(--accent-color);"></div>
      <div class="corner br" style="--accent-color: var(--accent-color);"></div>

      <header>
        <div>
          <h1>The Wizarding Joke Book</h1>
          <div class="subtitle">Summon enchanted jests from the ether ✨</div>
        </div>
        <div class="controls-top">  
          <div class="color-picker">
            <label for="colorPick">Theme</label>
            <input id="colorPick" type="color" value="#d4af37">
          </div>
        </div>
        <div class="controls-top">
            <div class="favorites">
            <button id="favBtn" class="btn-ghost">♥ Favorites</button>
            <div id="favList" class="fav-list"></div>
            <button id="shareBtn" class="btn-ghost">🔗 Share</button>
        </div>
      </header>

      <section class="joke-area" id="jokeArea">
        <p id="setup">Press <strong>Space</strong> or tap the button to conjure your first joke...</p>
        <!-- Magical Separator Line Added -->
        <div id="separator"></div>
        <p id="punchline"></p>
      </section>

      <div class="controls">
        <button id="jokeBtn" class="btn-main">Summon Joke ✨</button>
        <button id="readBtn" class="btn-ghost" title="Read Aloud">🔊 Read Aloud</button>
        <button id="copyBtn" class="btn-ghost">📋 Copy</button>
        <button id="saveBtn" class="btn-ghost">💾 Save</button>
       
      </div>

      <footer class="meta">
        <div class="status" id="status">Ready</div>
        <div style="font-style:italic">Enchanted with magic ✨</div>
      </footer>
    </div>
  </main>
  <script>
const API_JOKE = 'https://official-joke-api.appspot.com/random_joke';

const ui = {
    setup: document.getElementById('setup'),
    punchline: document.getElementById('punchline'),
    jokeArea: document.getElementById('jokeArea'),
    separator: document.getElementById('separator'),
    jokeBtn: document.getElementById('jokeBtn'),
    copyBtn: document.getElementById('copyBtn'),
    saveBtn: document.getElementById('saveBtn'),
    shareBtn: document.getElementById('shareBtn'),
    readBtn: document.getElementById('readBtn'),
    status: document.getElementById('status'),
    colorPick: document.getElementById('colorPick'),
    favBtn: document.getElementById('favBtn'),
    favList: document.getElementById('favList'),
};

const state = {
    joke: null,
    isFetching: false,
    isPlayingAudio: false,
};

// --- SIMPLE COLOR UPDATE ---
window.updateVisualColors = (newColor) => {
    document.documentElement.style.setProperty('--accent-color', newColor);
    document.querySelectorAll('.orb').forEach((orb, i) => {
        const alpha = [0.3, 0.2, 0.25][i];
        orb.style.background = `radial-gradient(circle, ${newColor}${Math.round(alpha * 255).toString(16)}, transparent)`;
    });
};

// --- HELPERS ---
const setStatus = (text, temp = false) => {
    ui.status.textContent = text;
    if (temp) setTimeout(() => ui.status.textContent = 'Ready', 2500);
};

const tempBtnText = (btn, text, duration = 2000) => {
    const original = btn.innerHTML;
    btn.innerHTML = text;
    setTimeout(() => btn.innerHTML = original, duration);
};

const setButtonsDisabled = (disabled) => {
    ui.jokeBtn.disabled = disabled;
    ui.copyBtn.disabled = disabled;
    ui.saveBtn.disabled = disabled;
    ui.shareBtn.disabled = disabled;
    ui.readBtn.disabled = disabled;
};

// --- CORE LOGIC ---
async function fetchWithRetry(url, options, maxRetries = 3) {
    let lastError = null;
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        const delay = Math.pow(2, attempt) * 1000;
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response;
        } catch (error) {
            lastError = error;
            if (attempt < maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    throw lastError;
}

async function fetchJoke() {
    if (state.isFetching || state.isPlayingAudio) return;
    state.isFetching = true;
    setButtonsDisabled(true);
    setStatus('Summoning...');
    ui.punchline.classList.remove('visible');
    ui.jokeArea.classList.remove('active');
    
    try {
        ui.setup.textContent = 'Channeling magical energies...';
        ui.setup.classList.add('loading');
        
        const res = await fetchWithRetry(API_JOKE, {cache: 'no-cache'});
        state.joke = await res.json();
        ui.setup.textContent = state.joke.setup;
        ui.setup.classList.remove('loading');
        ui.punchline.textContent = state.joke.punchline;
        
        setTimeout(() => {
            ui.punchline.classList.add('visible');
            ui.jokeArea.classList.add('active');
            setStatus('Joke conjured ✨');
        }, 1000);
        
    } catch (err) {
        console.error(err);
        ui.setup.textContent = 'The spell fizzled! Try again.';
        ui.punchline.textContent = '';
        ui.setup.classList.remove('loading');
        setStatus(err.message, true);
    } finally {
        state.isFetching = false;
        setButtonsDisabled(false);
    }
}

// --- READ ALOUD ---
async function readJoke() {
    if (!state.joke) return setStatus('No joke to read!', true);
    if (state.isPlayingAudio) {
        speechSynthesis.cancel();
        return;
    }

    const jokeText = `${state.joke.setup}. Punchline: ${state.joke.punchline}`;
    ui.readBtn.innerHTML = '⏹ Stop Reading';
    state.isPlayingAudio = true;
    setButtonsDisabled(true);
    ui.readBtn.disabled = false;
    setStatus('Casting Sonorous Charm...');

    try {
        const utterance = new SpeechSynthesisUtterance(jokeText);
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.name.includes('Female')) || voices[0];
        if (preferredVoice) utterance.voice = preferredVoice;

        utterance.onend = () => audioCleanup();
        utterance.onerror = () => audioCleanup();

        speechSynthesis.speak(utterance);
    } catch (err) {
        console.error(err);
        audioCleanup();
        setStatus('Read Aloud failed.', true);
    }
}

function audioCleanup() {
    state.isPlayingAudio = false;
    setButtonsDisabled(false);
    ui.readBtn.innerHTML = '🔊 Read Aloud';
}


// --- COPY & SHARE ---
async function copyJoke() {
    if (!state.joke?.punchline) return setStatus('Nothing to copy', true);
    try {
        const textToCopy = `${state.joke.setup}\n\n${state.joke.punchline}`;
        const tempInput = document.createElement('textarea');
        tempInput.value = textToCopy;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        setStatus('Copied to clipboard!', true);
        tempBtnText(ui.copyBtn, '✓ Copied');
    } catch {
        setStatus('Copy failed', true);
    }
}

async function shareJoke() {
    if (!state.joke) return setStatus('Nothing to share', true);
    const shareData = {
        title: 'A Wizarding Joke',
        text: `${state.joke.setup}\n\n${state.joke.punchline}`,
        url: window.location.href,
    };
    try {
        if (navigator.share) {
            await navigator.share(shareData);
            setStatus('Shared successfully!', true);
        } else {
            throw new Error('Web Share API not supported.');
        }
    } catch {
        copyJoke();
        setStatus('Share not available, joke copied!', true);
        tempBtnText(ui.shareBtn, '✓ Copied');
    }
}

// --- FAVORITES ---
const favorites = {
    _key: 'wj_favs_v2',
    load: () => JSON.parse(localStorage.getItem(favorites._key) || '[]'),
    save: (list) => localStorage.setItem(favorites._key, JSON.stringify(list)),
    add: () => {
        if (!state.joke) return setStatus('Nothing to save', true);
        const favs = favorites.load();
        if (!favs.some(j => j.setup === state.joke.setup)) {
            favs.push(state.joke);
            favorites.save(favs);
            favorites.render();
            setStatus('Saved to favorites!', true);
            tempBtnText(ui.saveBtn, '✓ Saved');
        } else {
            setStatus('Already in favorites!', true);
        }
    },
    remove: (index) => {
        const favs = favorites.load();
        favs.splice(index, 1);
        favorites.save(favs);
        favorites.render();
        setStatus('Favorite removed.', true);
    },
    render: () => {
        const favs = favorites.load();
        ui.favList.innerHTML = '';
        if (!favs.length) {
            ui.favList.innerHTML = '<div class="fav-empty">No enchanted jests saved yet.</div>';
            return;
        }
        favs.slice().reverse().forEach((joke, i) => {
            const index = favs.length - 1 - i;
            const div = document.createElement('div');
            div.className = 'fav-item';
            div.innerHTML = `
                <span class="fav-item-text">${joke.punchline}</span>
                <div class="fav-item-controls">
                    <button class="btn-ghost" data-copy-fav="${index}" title="Copy">📋</button>
                    <button class="btn-ghost" data-delete-fav="${index}" title="Delete">🗑️</button>
                </div>`;
            ui.favList.appendChild(div);
        });
    }
};


// --- EVENT LISTENERS ---
ui.jokeBtn.addEventListener('click', fetchJoke);
ui.copyBtn.addEventListener('click', copyJoke);
ui.saveBtn.addEventListener('click', favorites.add);
ui.shareBtn.addEventListener('click', shareJoke);
ui.readBtn.addEventListener('click', readJoke);
ui.colorPick.addEventListener('input', e => updateVisualColors(e.target.value));

ui.favBtn.addEventListener('click', () => {
    if (state.isPlayingAudio) speechSynthesis.cancel();
    ui.favList.classList.toggle('show');
    if (ui.favList.classList.contains('show')) favorites.render();
});

ui.favList.addEventListener('click', (e) => {
    const copyTarget = e.target.closest('[data-copy-fav]');
    const deleteTarget = e.target.closest('[data-delete-fav]');
    const favItem = e.target.closest('.fav-item');

    const favs = favorites.load();

    if (copyTarget) {
        const index = parseInt(copyTarget.dataset.copyFav);
        const text = `${favs[index].setup}\n\n${favs[index].punchline}`;
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        setStatus('Favorite copied!', true);
    } 
    else if (deleteTarget) {
        const index = parseInt(deleteTarget.dataset.deleteFav);
        favorites.remove(index);
    } 
    else if (favItem) {
        // Load the clicked favorite onto the main joke card
        const index = Array.from(ui.favList.children).indexOf(favItem);
        const favIndex = favs.length - 1 - index; // because you reversed when rendering
        const joke = favs[favIndex];
        state.joke = joke;
        ui.setup.textContent = joke.setup;
        ui.punchline.textContent = joke.punchline;
        ui.punchline.classList.add('visible');
        ui.jokeArea.classList.add('active');
        setStatus('Favorite loaded!', true);
        ui.favList.classList.remove('show'); // optional: hide favorites after selection
    }
});


window.addEventListener('keydown', (e) => {
    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'BUTTON') return;
    if (e.code === 'Space' || e.key === 'Enter') {
        e.preventDefault();
        if (!state.isFetching && !state.isPlayingAudio) fetchJoke();
    }
});

// --- INIT ---
window.addEventListener('load', () => {
    favorites.render();
    updateVisualColors(ui.colorPick.value);
});
</script>


 
</body>
</html>
